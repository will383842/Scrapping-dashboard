# ============================================================================
# POSTGRESQL CONFIGURATION - SCRAPER PRO PRODUCTION (CORRIGÉ)
# Version: 2.0 Simplifié pour fonctionnement conteneur Docker
# ============================================================================

# ==========================================================================
# CONNECTIONS ET AUTHENTIFICATION
# ==========================================================================
max_connections = 100
superuser_reserved_connections = 3
listen_addresses = '*'
port = 5432

# Paramètres de timeout pour éviter "connection already closed"
tcp_keepalives_idle = 600          # 10 minutes
tcp_keepalives_interval = 30       # 30 secondes
tcp_keepalives_count = 3
idle_in_transaction_session_timeout = 1800000  # 30 minutes

# ==========================================================================  
# MÉMOIRE
# ==========================================================================
shared_buffers = 128MB             # Ajusté pour conteneur
effective_cache_size = 512MB       
work_mem = 16MB                    
maintenance_work_mem = 64MB        
autovacuum_work_mem = 64MB         

# ==========================================================================
# WRITE AHEAD LOG (WAL)
# ==========================================================================
wal_buffers = 16MB
wal_level = replica
max_wal_size = 1GB
min_wal_size = 256MB
checkpoint_completion_target = 0.9
checkpoint_timeout = 5min
checkpoint_warning = 30s

# ==========================================================================
# QUERY PLANNER
# ==========================================================================
random_page_cost = 1.1             # SSD storage
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025
effective_io_concurrency = 200     # Pour SSD

# ==========================================================================
# LOGGING POUR DEBUG
# ==========================================================================
log_destination = 'stderr'
logging_collector = off            # Simplifié pour Docker
log_min_messages = warning         # Moins verbeux
log_min_error_statement = error
log_min_duration_statement = 1000  # Log requêtes > 1 seconde
log_statement = 'none'            # Pas de log des statements
log_checkpoints = on
log_connections = on
log_disconnections = on
log_line_prefix = '%t [%p] %q%u@%d '
log_timezone = 'UTC'

# ==========================================================================
# AUTOVACUUM OPTIMISÉ
# ==========================================================================
autovacuum = on
autovacuum_max_workers = 2         # Réduit pour conteneur
autovacuum_naptime = 60s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1

# ==========================================================================
# STATISTIQUES
# ==========================================================================
track_activities = on
track_counts = on  
track_functions = none             # Simplifié
track_io_timing = on

# ==========================================================================
# LOCALE ET FORMATAGE
# ==========================================================================
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

# ==========================================================================
# SÉCURITÉ SIMPLIFIÉE
# ==========================================================================
ssl = off                          # Désactivé pour éviter problèmes
password_encryption = scram-sha-256

# ==========================================================================
# PERFORMANCE DE BASE
# ==========================================================================
# Parallel queries
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4

# JIT désactivé pour stabilité
jit = off

# ==========================================================================
# MAINTENANCE
# ==========================================================================
vacuum_cost_delay = 0
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20
vacuum_cost_limit = 200

# Background writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0