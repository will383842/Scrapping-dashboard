# ============================================================================
# FIX-DATABASE-ISSUES.PS1 - Script de Correction des Probl√®mes DB
# Version: 2.0 - R√©solution compl√®te des erreurs PostgreSQL
# ============================================================================

param(
    [switch]$Force = $false,
    [switch]$Verbose = $false,
    [switch]$ResetData = $false
)

$ErrorActionPreference = "Continue"

function Write-Status($Message, $Color = "White") {
    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-Host "$timestamp - $Message" -ForegroundColor $Color
}

function Write-Success($Message) { Write-Status $Message "Green" }
function Write-Warning($Message) { Write-Status $Message "Yellow" }
function Write-Error($Message) { Write-Status $Message "Red" }
function Write-Info($Message) { Write-Status $Message "Cyan" }

Write-Host @"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                üîß CORRECTION COMPL√àTE PROBL√àMES DATABASE                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"@ -ForegroundColor Magenta

# ============================================================================
# √âTAPE 1: DIAGNOSTIC COMPLET
# ============================================================================
Write-Info "=== √âTAPE 1: DIAGNOSTIC COMPLET ==="

# V√©rifier Docker
Write-Info "V√©rification de Docker..."
try {
    $dockerVersion = docker --version
    Write-Success "Docker d√©tect√©: $dockerVersion"
    
    $composeVersion = docker compose version
    Write-Success "Docker Compose d√©tect√©: $composeVersion"
} catch {
    Write-Error "Docker non disponible. Installez Docker Desktop et red√©marrez."
    exit 1
}

# V√©rifier les fichiers requis
$requiredFiles = @(
    "docker-compose.yml",
    ".env",
    "config/postgresql.conf",
    "db/init.sql"
)

foreach ($file in $requiredFiles) {
    if (Test-Path $file) {
        Write-Success "‚úì $file trouv√©"
    } else {
        Write-Error "‚úó $file manquant"
        if ($file -eq ".env") {
            if (Test-Path ".env.example") {
                Write-Info "Cr√©ation du fichier .env depuis .env.example..."
                Copy-Item ".env.example" ".env"
                Write-Success "Fichier .env cr√©√©"
            } else {
                Write-Error "Fichier .env.example manquant √©galement"
                exit 1
            }
        } else {
            Write-Error "Fichier requis manquant: $file"
            exit 1
        }
    }
}

# V√©rifier le contenu du fichier .env
Write-Info "V√©rification de la configuration .env..."
$envContent = Get-Content ".env" -ErrorAction SilentlyContinue
$requiredVars = @("POSTGRES_PASSWORD", "POSTGRES_USER", "POSTGRES_DB")

foreach ($var in $requiredVars) {
    $found = $envContent | Where-Object { $_ -match "^$var=" }
    if ($found) {
        Write-Success "‚úì $var configur√©"
    } else {
        Write-Error "‚úó $var manquant dans .env"
        exit 1
    }
}

# ============================================================================
# √âTAPE 2: ARR√äT COMPLET ET NETTOYAGE
# ============================================================================
Write-Info "=== √âTAPE 2: ARR√äT COMPLET ET NETTOYAGE ==="

Write-Info "Arr√™t de tous les conteneurs..."
docker compose down --remove-orphans

Write-Info "Suppression des conteneurs existants..."
$scraperContainers = docker ps -a -q --filter "name=scraper-pro"
if ($scraperContainers) {
    docker rm -f $scraperContainers
    Write-Success "Conteneurs supprim√©s"
}

Write-Info "Nettoyage des r√©seaux..."
try {
    docker network rm scraper-pro-internal 2>$null
    docker network prune -f
    Write-Success "R√©seaux nettoy√©s"
} catch {
    Write-Info "Nettoyage r√©seau termin√©"
}

# Suppression des volumes si demand√©
if ($ResetData) {
    Write-Warning "Suppression des donn√©es (--ResetData activ√©)..."
    docker volume rm scraper-pro_pgdata 2>$null
    Write-Success "Volume de donn√©es supprim√©"
} else {
    Write-Info "Conservation des donn√©es existantes (utilisez -ResetData pour les supprimer)"
}

# ============================================================================
# √âTAPE 3: V√âRIFICATION ET CORRECTION DES FICHIERS
# ============================================================================
Write-Info "=== √âTAPE 3: V√âRIFICATION DES FICHIERS ==="

# V√©rifier que postgresql.conf ne contient pas de param√®tres probl√©matiques
$postgresqlConf = Get-Content "config/postgresql.conf" -ErrorAction SilentlyContinue
if ($postgresqlConf) {
    $problematicLines = $postgresqlConf | Where-Object { $_ -match "^ALTER SYSTEM SET" }
    if ($problematicLines) {
        Write-Warning "Configuration PostgreSQL contient des param√®tres probl√©matiques"
        Write-Info "Les param√®tres ALTER SYSTEM SET seront ignor√©s"
    } else {
        Write-Success "Configuration PostgreSQL correcte"
    }
}

# V√©rifier les permissions des dossiers
$directories = @("logs", "backups", "sessions")
foreach ($dir in $directories) {
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Force -Path $dir | Out-Null
        Write-Success "Dossier $dir cr√©√©"
    }
}

# ============================================================================
# √âTAPE 4: CONSTRUCTION DES IMAGES
# ============================================================================
Write-Info "=== √âTAPE 4: CONSTRUCTION DES IMAGES ==="

Write-Info "Construction des images Docker..."
try {
    # Construction en mode no-cache pour √©viter les probl√®mes
    docker compose build --no-cache
    Write-Success "Images construites avec succ√®s"
} catch {
    Write-Error "Erreur lors de la construction des images"
    Write-Info "Tentative de construction image par image..."
    
    try {
        docker build --no-cache -f Dockerfile.worker -t scraper-pro-worker .
        docker build --no-cache -f Dockerfile.dashboard -t scraper-pro-dashboard .
        Write-Success "Images construites individuellement"
    } catch {
        Write-Error "Impossible de construire les images"
        exit 1
    }
}

# ============================================================================
# √âTAPE 5: D√âMARRAGE PROGRESSIF
# ============================================================================
Write-Info "=== √âTAPE 5: D√âMARRAGE PROGRESSIF ==="

# D√©marrage de la base de donn√©es uniquement
Write-Info "D√©marrage de la base de donn√©es..."
docker compose up -d db

# Attente avec monitoring d√©taill√©
Write-Info "Attente de l'initialisation de la base de donn√©es..."
$maxAttempts = 60
$attempt = 0
$dbReady = $false

do {
    $attempt++
    Start-Sleep -Seconds 2
    
    # Test de sant√© d√©taill√©
    try {
        # Test de connexion basique
        $healthCheck = docker compose exec -T db pg_isready -h localhost -p 5432 -U scraper_admin -d scraper_pro 2>$null
        
        if ($LASTEXITCODE -eq 0) {
            # Test de connexion avec authentification
            $authTest = docker compose exec -T db psql -U scraper_admin -d scraper_pro -c "SELECT 1;" 2>$null
            
            if ($LASTEXITCODE -eq 0) {
                $dbReady = $true
                Write-Success "Base de donn√©es pr√™te et accessible!"
                break
            } else {
                if ($Verbose) {
                    Write-Info "DB ready mais auth failed - tentative $attempt/$maxAttempts"
                }
            }
        } else {
            if ($Verbose) {
                Write-Info "DB not ready - tentative $attempt/$maxAttempts"
            }
        }
    } catch {
        if ($Verbose) {
            Write-Info "Exception lors du test DB - tentative $attempt/$maxAttempts"
        }
    }
    
    # Affichage p√©riodique du statut
    if ($attempt % 10 -eq 0) {
        Write-Info "Attente DB... ($attempt/$maxAttempts)"
        
        # V√©rifier les logs en cas de probl√®me
        if ($attempt -gt 30) {
            Write-Info "V√©rification des logs de la base de donn√©es..."
            docker compose logs db --tail=10
        }
    }
    
} while ($attempt -lt $maxAttempts)

if (-not $dbReady) {
    Write-Error "ERREUR: Base de donn√©es non pr√™te apr√®s $maxAttempts tentatives"
    Write-Info "Affichage des logs de la base de donn√©es:"
    docker compose logs db --tail=20
    Write-Info "V√©rifiez la configuration et relancez le script"
    exit 1
}

# Test de connexion approfondi
Write-Info "Test de connexion approfondi..."
$dbTest = docker compose exec -T db psql -U scraper_admin -d scraper_pro -c "SELECT NOW(), version();" 2>$null

if ($LASTEXITCODE -eq 0) {
    Write-Success "Test de connexion avanc√© r√©ussi"
    if ($Verbose) {
        Write-Info "R√©sultat du test DB:"
        $dbTest | Write-Host -ForegroundColor Gray
    }
} else {
    Write-Warning "Test de connexion avanc√© √©chou√© mais DB semble pr√™te"
}

# ============================================================================
# √âTAPE 6: D√âMARRAGE DES AUTRES SERVICES
# ============================================================================
Write-Info "=== √âTAPE 6: D√âMARRAGE DES AUTRES SERVICES ==="

Write-Info "D√©marrage du worker..."
docker compose up -d worker

Write-Info "Attente du d√©marrage du worker (20 secondes)..."
Start-Sleep -Seconds 20

# Test du worker
$workerLogs = docker compose logs worker --tail=10 2>$null
if ($workerLogs -match "error|Error|ERROR|exception|Exception") {
    Write-Warning "Erreurs d√©tect√©es dans les logs du worker:"
    $workerLogs | Where-Object { $_ -match "error|Error|ERROR|exception|Exception" } | ForEach-Object {
        Write-Host "  $_" -ForegroundColor Red
    }
} else {
    Write-Success "Worker d√©marr√© sans erreurs apparentes"
}

Write-Info "D√©marrage du dashboard..."
docker compose up -d dashboard

Write-Info "Attente du d√©marrage du dashboard (20 secondes)..."
Start-Sleep -Seconds 20

# ============================================================================
# √âTAPE 7: V√âRIFICATION FINALE
# ============================================================================
Write-Info "=== √âTAPE 7: V√âRIFICATION FINALE ==="

# Status des conteneurs
Write-Info "√âtat final des conteneurs:"
$finalStatus = docker compose ps --format "table {{.Name}}\t{{.Status}}"
Write-Output $finalStatus

# Test d'acc√®s au dashboard
Write-Info "Test d'acc√®s au dashboard..."
try {
    $response = Invoke-WebRequest -Uri "http://localhost:8501" -UseBasicParsing -TimeoutSec 30 -ErrorAction SilentlyContinue
    if ($response.StatusCode -eq 200) {
        Write-Success "‚úÖ Dashboard accessible: http://localhost:8501"
    } else {
        Write-Warning "‚ö†Ô∏è Dashboard r√©pond mais avec le code: $($response.StatusCode)"
    }
} catch {
    Write-Warning "‚ö†Ô∏è Dashboard pas encore accessible: $($_.Exception.Message)"
    Write-Info "Le dashboard peut prendre quelques minutes suppl√©mentaires pour √™tre compl√®tement fonctionnel"
}

# Test de sant√© des connexions DB
Write-Info "Test final des connexions DB..."
$dbHealthTest = docker compose exec -T db psql -U scraper_admin -d scraper_pro -c "SELECT 'DB_OK' as status, COUNT(*) as queue_count FROM queue;" 2>$null

if ($LASTEXITCODE -eq 0) {
    Write-Success "‚úÖ Connexions DB op√©rationnelles"
    if ($Verbose -and $dbHealthTest) {
        Write-Info "R√©sultat test sant√©:"
        $dbHealthTest | Write-Host -ForegroundColor Gray
    }
} else {
    Write-Warning "‚ö†Ô∏è Probl√®me potentiel avec les connexions DB"
}

# V√©rification des logs pour erreurs r√©centes
Write-Info "V√©rification des erreurs r√©centes..."
$recentLogs = docker compose logs --since 60s 2>$null
$connectionErrors = $recentLogs | Select-String -Pattern "connection already closed|InterfaceError|OperationalError|connection refused"

if ($connectionErrors) {
    Write-Warning "‚ö†Ô∏è Erreurs de connexion d√©tect√©es dans les logs r√©cents:"
    $connectionErrors | ForEach-Object { Write-Host "  $_" -ForegroundColor Red }
    Write-Info "Ces erreurs peuvent √™tre normales pendant le d√©marrage initial"
} else {
    Write-Success "‚úÖ Aucune erreur de connexion d√©tect√©e"
}

# ============================================================================
# RAPPORT FINAL
# ============================================================================
Write-Host @"

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                           üìä RAPPORT FINAL                                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"@ -ForegroundColor Magenta

Write-Success "üéâ CORRECTION TERMIN√âE AVEC SUCC√àS!"

Write-Info "‚úÖ Actions r√©alis√©es:"
Write-Info "  - Nettoyage complet des conteneurs et r√©seaux"
Write-Info "  - V√©rification et correction des fichiers de configuration"
Write-Info "  - Reconstruction des images Docker"
Write-Info "  - D√©marrage progressif et valid√© des services"
Write-Info "  - Tests de connectivit√© et de sant√©"

Write-Info "üìã Services d√©ploy√©s:"
Write-Info "  - PostgreSQL Database: Port 5432"
Write-Info "  - Worker Scrapy/Playwright: Background service"
Write-Info "  - Dashboard Streamlit: http://localhost:8501"

Write-Info "üîß Prochaines √©tapes:"
Write-Info "  1. Ouvrir http://localhost:8501 dans votre navigateur"
Write-Info "  2. Vous connecter avec vos credentials du fichier .env"
Write-Info "  3. Configurer vos proxies dans 'Proxy Management'"
Write-Info "  4. Cr√©er un job test dans 'Jobs Manager'"

if ($connectionErrors) {
    Write-Warning "‚ö†Ô∏è ATTENTION: Quelques erreurs de connexion d√©tect√©es"
    Write-Info "Si les probl√®mes persistent:"
    Write-Info "  - Red√©marrez Docker Desktop"
    Write-Info "  - Relancez ce script avec -ResetData pour un reset complet"
    Write-Info "  - V√©rifiez les logs: docker compose logs -f"
} else {
    Write-Success "üéâ SYST√àME COMPL√àTEMENT OP√âRATIONNEL!"
}

Write-Info "Pour surveiller le syst√®me:"
Write-Info "  docker compose ps              # Status des services"
Write-Info "  docker compose logs -f         # Logs en temps r√©el"
Write-Info "  docker compose logs db         # Logs base de donn√©es uniquement"